---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getNewsBySlug, getLatestNews } from '../../lib/news';
import { config } from '../../config';

// 動的ルーティング用
export async function getStaticPaths() {
  const { getAllNews } = await import('../../lib/news');
  const allNews = await getAllNews();

  return allNews.map((article) => ({
    params: { slug: article.slug },
    props: { article },
  }));
}

const { slug } = Astro.params;
const { article } = Astro.props;

// 関連記事を取得（改善版: タグベースの関連度スコアリング）
let relatedArticles = [];
try {
  const allArticles = await getLatestNews(50);

  // 関連度スコアを計算
  const scoredArticles = allArticles
    .filter(a => a.slug !== slug)
    .map(a => {
      let score = 0;

      // 同じカテゴリ: +10点
      if (a.category === article.category) {
        score += 10;
      }

      // タグの一致数でスコア加算: 各+5点
      const currentTags = article.tags || [];
      const otherTags = a.tags || [];
      const matchingTags = currentTags.filter(tag => otherTags.includes(tag));
      score += matchingTags.length * 5;

      return { article: a, score };
    })
    .filter(item => item.score > 0) // スコア0のものは除外
    .sort((a, b) => b.score - a.score) // スコア降順
    .slice(0, 4) // トップ4を取得
    .map(item => item.article);

  relatedArticles = scoredArticles;
} catch (error) {
  console.warn('関連記事の取得に失敗しました');
}

// 構造化データ
const siteUrl = config.domain ? `https://${config.domain}` : 'https://keiba-nyumon.jp';
const articleUrl = `${siteUrl}/news/${slug}/`;

// NewsArticle構造化データ（SEO最適化: 更新日対応）
const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'NewsArticle',
  headline: article.title,
  description: article.excerpt,
  image: article.thumbnail || `${siteUrl}/og-image.png`,
  url: articleUrl,
  datePublished: new Date(article.publishedAt).toISOString(),
  dateModified: article.updatedAt ? new Date(article.updatedAt).toISOString() : new Date(article.publishedAt).toISOString(),
  author: {
    '@type': 'Person',
    name: article.author || 'AI編集部',
  },
  publisher: {
    '@type': 'Organization',
    name: config.name,
    url: siteUrl,
    logo: {
      '@type': 'ImageObject',
      url: `${siteUrl}/logo.png`,
    }
  },
  inLanguage: 'ja-JP',
};

// BreadcrumbList構造化データ（SEO最適化）
const breadcrumbStructuredData = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: 'ホーム',
      item: `${siteUrl}/`
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: 'ニュース',
      item: `${siteUrl}/#news`
    },
    {
      '@type': 'ListItem',
      position: 3,
      name: article.title,
      item: articleUrl
    }
  ]
};

// SEO最適化されたalt属性
const categoryMap: Record<string, string> = {
  'kiso': '競馬の基礎知識',
  'baken': '馬券の買い方',
  'yougo': '競馬用語集',
  'nankan': '南関競馬入門',
  'data': 'データ予想入門'
};
const categoryLabel = categoryMap[article.category] || article.category;
const optimizedAlt = `${categoryLabel}: ${article.title} - 競馬初心者向け詳細解説記事`;

// 推定読了時間を計算（日本語は500文字/分）
function calculateReadingTime(content: string): number {
  const plainText = content
    .replace(/<[^>]*>/g, '') // HTMLタグを削除
    .replace(/\s+/g, '') // 空白を削除
    .trim();

  const charCount = plainText.length;
  const readingTimeMinutes = Math.ceil(charCount / 500); // 500文字/分

  return Math.max(1, readingTimeMinutes); // 最低1分
}

const readingTime = calculateReadingTime(article.content || '');

// Markdownを簡易的にHTMLに変換
function markdownToHtml(markdown: string): string {
  return markdown
    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
    .replace(/^# (.+)$/gm, '<h1>$1</h1>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/\n\n/g, '</p><p>')
    .replace(/^(.+)$/gm, '<p>$1</p>')
    .replace(/<\/p><p><h([1-3])>/g, '</p><h$1>')
    .replace(/<\/h([1-3])><\/p>/g, '</h$1>');
}

const htmlContent = markdownToHtml(article.content);
---

<BaseLayout
  title={`${article.title} | ${config.name}`}
  description={article.excerpt}
>
  <!-- 構造化データ: NewsArticle -->
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />

  <!-- 構造化データ: BreadcrumbList（SEO最適化） -->
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbStructuredData)} />

  <!-- 記事コンテンツ -->
  <article class="article-container">
    <!-- パンくずリスト -->
    <nav class="breadcrumb">
      <a href="/">ホーム</a>
      <span class="separator">›</span>
      <a href="/#news">ニュース</a>
      <span class="separator">›</span>
      <span class="current">{article.title}</span>
    </nav>

    <!-- 記事ヘッダー -->
    <header class="article-header">
      <div class="article-meta">
        <span class={`badge badge-${article.category}`}>{article.category}</span>
        {article.tags && article.tags.map(tag => (
          <span class="tag">#{tag}</span>
        ))}
      </div>

      <h1 class="article-title">{article.title}</h1>

      <div class="article-info">
        <div class="info-item">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          <span class="info-label">公開:</span>
          <time datetime={new Date(article.publishedAt).toISOString()}>
            {new Date(article.publishedAt).toLocaleDateString('ja-JP', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })}
          </time>
        </div>
        {article.updatedAt && (
          <div class="info-item updated">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            <span class="info-label">更新:</span>
            <time datetime={new Date(article.updatedAt).toISOString()}>
              {new Date(article.updatedAt).toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              })}
            </time>
          </div>
        )}
        <div class="info-item">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
          <span>{article.author || 'AI編集部'}</span>
        </div>
        <div class="info-item reading-time">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>約 {readingTime} 分</span>
        </div>
      </div>
    </header>

    <!-- サムネイル画像 -->
    {article.thumbnail && (
      <div class="article-thumbnail">
        <img
          src={article.thumbnail}
          alt={optimizedAlt}
          width="1200"
          height="675"
          loading="eager"
          decoding="async"
        />
      </div>
    )}

    <!-- 記事本文 -->
    <div class="article-content" set:html={htmlContent} />

    <!-- SNSシェアボタン -->
    <div class="share-buttons">
      <p class="share-title">この記事をシェア</p>
      <div class="share-icons">
        <a
          href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(article.title)}&url=${encodeURIComponent(articleUrl)}`}
          target="_blank"
          rel="noopener noreferrer"
          class="share-btn twitter"
          aria-label="Twitterでシェア"
        >
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
          </svg>
        </a>
        <a
          href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(articleUrl)}`}
          target="_blank"
          rel="noopener noreferrer"
          class="share-btn facebook"
          aria-label="Facebookでシェア"
        >
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
          </svg>
        </a>
        <a
          href={`https://line.me/R/msg/text/?${encodeURIComponent(article.title + ' ' + articleUrl)}`}
          target="_blank"
          rel="noopener noreferrer"
          class="share-btn line"
          aria-label="LINEでシェア"
        >
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346 0 .627.285.627.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.105.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/>
          </svg>
        </a>
      </div>
    </div>

    <!-- 関連記事 -->
    {relatedArticles.length > 0 && (
      <section class="related-articles">
        <h2 class="related-title">関連記事</h2>
        <div class="related-grid">
          {relatedArticles.map(related => (
            <a href={`/news/${related.slug}/`} class="related-card">
              <span class={`badge badge-${related.category}`}>{related.category}</span>
              <h3 class="related-card-title">{related.title}</h3>
              <p class="related-card-excerpt">{related.excerpt}</p>
            </a>
          ))}
        </div>
      </section>
    )}

    <!-- 記事一覧に戻る -->
    <div class="back-to-list">
      <a href="/" class="back-btn">
        ← 記事一覧に戻る
      </a>
    </div>
  </article>
</BaseLayout>

<style>
  .article-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  .breadcrumb {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: #6b7280;
    margin-bottom: 2rem;
  }

  .breadcrumb a {
    color: #42a5f5;
    text-decoration: none;
    transition: color 0.2s;
  }

  .breadcrumb a:hover {
    color: #1e88e5;
  }

  .separator {
    color: #d1d5db;
  }

  .current {
    color: #111827;
    font-weight: 500;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 300px;
  }

  .article-header {
    margin-bottom: 2rem;
  }

  .article-meta {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }

  .badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 700;
    border-radius: 6px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .badge-ニュース {
    background: #dbeafe;
    color: #2563eb;
  }

  .badge-ランキング {
    background: #e9d5ff;
    color: #9333ea;
  }

  .badge-ガイド {
    background: #d1fae5;
    color: #059669;
  }

  .badge-まとめ {
    background: #fed7aa;
    color: #ea580c;
  }

  .tag {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    color: #6b7280;
    background: #f3f4f6;
    border-radius: 6px;
  }

  .article-title {
    font-size: 2rem;
    font-weight: 800;
    color: #111827;
    line-height: 1.3;
    margin: 0 0 1rem 0;
  }

  .article-info {
    display: flex;
    gap: 1.5rem;
    font-size: 0.875rem;
    color: #6b7280;
    flex-wrap: wrap;
  }

  .info-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .info-item.updated {
    color: #059669;
    font-weight: 500;
  }

  .info-item.reading-time {
    color: #0ea5e9;
    font-weight: 500;
    background: rgba(14, 165, 233, 0.1);
    padding: 0.25rem 0.75rem;
    border-radius: 6px;
  }

  .info-label {
    font-weight: 600;
    color: #4b5563;
  }

  .icon {
    width: 20px;
    height: 20px;
  }

  .article-thumbnail {
    width: 100%;
    aspect-ratio: 16 / 9;
    border-radius: 16px;
    overflow: hidden;
    margin-bottom: 2rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
  }

  .article-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .article-content {
    font-size: 1.125rem;
    line-height: 1.8;
    color: #374151;
    margin-bottom: 3rem;
  }

  .article-content :global(h2) {
    font-size: 1.75rem;
    font-weight: 700;
    color: #111827;
    margin: 2rem 0 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #e5e7eb;
  }

  .article-content :global(h3) {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
    margin: 1.5rem 0 1rem;
  }

  .article-content :global(p) {
    margin: 1rem 0;
  }

  .article-content :global(strong) {
    font-weight: 700;
    color: #111827;
  }

  .article-content :global(em) {
    font-style: italic;
  }

  .share-buttons {
    padding: 2rem 0;
    border-top: 2px solid #e5e7eb;
    border-bottom: 2px solid #e5e7eb;
    margin-bottom: 3rem;
  }

  .share-title {
    font-size: 1rem;
    font-weight: 600;
    color: #6b7280;
    margin: 0 0 1rem 0;
  }

  .share-icons {
    display: flex;
    gap: 1rem;
  }

  .share-btn {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s;
    text-decoration: none;
  }

  .share-btn svg {
    width: 24px;
    height: 24px;
  }

  .share-btn.twitter {
    background: #1da1f2;
    color: white;
  }

  .share-btn.twitter:hover {
    background: #1a91da;
    transform: scale(1.1);
  }

  .share-btn.facebook {
    background: #1877f2;
    color: white;
  }

  .share-btn.facebook:hover {
    background: #166fe5;
    transform: scale(1.1);
  }

  .share-btn.line {
    background: #00c300;
    color: white;
  }

  .share-btn.line:hover {
    background: #00b300;
    transform: scale(1.1);
  }

  .related-articles {
    margin-bottom: 3rem;
  }

  .related-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #111827;
    margin-bottom: 1.5rem;
  }

  .related-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1rem;
  }

  .related-card {
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 1.5rem;
    text-decoration: none;
    transition: all 0.3s;
  }

  .related-card:hover {
    border-color: #42a5f5;
    box-shadow: 0 4px 12px rgba(66, 165, 245, 0.2);
    transform: translateY(-2px);
  }

  .related-card-title {
    font-size: 1rem;
    font-weight: 600;
    color: #111827;
    margin: 0.75rem 0 0.5rem;
    line-height: 1.4;
  }

  .related-card-excerpt {
    font-size: 0.875rem;
    color: #6b7280;
    margin: 0;
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .back-to-list {
    text-align: center;
  }

  .back-btn {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    background: #42a5f5;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s;
  }

  .back-btn:hover {
    background: #1e88e5;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(66, 165, 245, 0.3);
  }

  @media (max-width: 640px) {
    .article-container {
      padding: 1rem;
    }

    .article-title {
      font-size: 1.5rem;
    }

    .article-content {
      font-size: 1rem;
    }

    .article-content :global(h2) {
      font-size: 1.5rem;
    }

    .article-content :global(h3) {
      font-size: 1.25rem;
    }

    .related-grid {
      grid-template-columns: 1fr;
    }

    .current {
      max-width: 150px;
    }
  }
</style>
