name: Auto Deploy to Netlify

on:
  # è¨˜äº‹ãŒAirtableã«è¿½åŠ ã•ã‚ŒãŸã¨ãã«æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ã€ã¾ãŸã¯æ¯æ—¥åˆå‰6æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
  schedule:
    - cron: '0 21 * * *' # æ¯æ—¥UTC 21:00ï¼ˆJST 6:00AMï¼‰
  workflow_dispatch:
    inputs:
      reason:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ç†ç”±'
        required: false
        default: 'Manual trigger'
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build site
        env:
          KEIBA_NYUMON_AIRTABLE_API_KEY: ${{ secrets.KEIBA_NYUMON_AIRTABLE_API_KEY }}
          KEIBA_NYUMON_AIRTABLE_BASE_ID: ${{ secrets.KEIBA_NYUMON_AIRTABLE_BASE_ID }}
          AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
          AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
        run: npm run build

      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: './dist'
          production-deploy: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Auto deploy: ${{ github.event.inputs.reason || 'Scheduled deployment' }}"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Summary
        if: success()
        run: |
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ"
          echo "ğŸŒ ã‚µã‚¤ãƒˆURL: https://keiba-nyumon.netlify.app"
          echo "ğŸ“… å®Ÿè¡Œæ—¥æ™‚: $(date)"

      - name: Failure notification
        if: failure()
        run: |
          echo "âŒ ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—ã—ã¾ã—ãŸ"
          echo "ğŸ“‹ GitHub Actionsãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          echo "ğŸ”— https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
