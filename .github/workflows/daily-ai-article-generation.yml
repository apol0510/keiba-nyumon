name: Daily AI Article Generation

on:
  schedule:
    # æ¯æ—¥AM6æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œï¼ˆUTC 21:00ï¼‰
    - cron: '0 21 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      article_count:
        description: 'ç”Ÿæˆã™ã‚‹è¨˜äº‹æ•°'
        required: false
        default: '3'
        type: string

jobs:
  generate-articles:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check environment
        run: |
          echo "ğŸ“‹ ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯"
          echo "KEIBA_NYUMON_AIRTABLE_API_KEY: ${{ secrets.KEIBA_NYUMON_AIRTABLE_API_KEY != '' && 'SET' || 'NOT SET' }}"
          echo "KEIBA_NYUMON_AIRTABLE_BASE_ID: ${{ secrets.KEIBA_NYUMON_AIRTABLE_BASE_ID != '' && 'SET' || 'NOT SET' }}"
          echo "AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY != '' && 'SET' || 'NOT SET' }}"
          echo "AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID != '' && 'SET' || 'NOT SET' }}"
          echo "ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY != '' && 'SET' || 'NOT SET' }}"
          echo "Node version: $(node --version)"
          echo "npm version: $(npm --version)"

      - name: Generate AI articles
        env:
          KEIBA_NYUMON_AIRTABLE_API_KEY: ${{ secrets.KEIBA_NYUMON_AIRTABLE_API_KEY }}
          KEIBA_NYUMON_AIRTABLE_BASE_ID: ${{ secrets.KEIBA_NYUMON_AIRTABLE_BASE_ID }}
          AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
          AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ARTICLE_COUNT: ${{ inputs.article_count || '3' }}
        run: node --no-warnings scripts/generate-ai-news.cjs

      - name: Trigger Netlify Build via Build Hook
        if: success()
        run: |
          curl -X POST -d '{}' ${{ secrets.NETLIFY_BUILD_HOOK_URL }}
          echo "âœ… Netlify Build Hook triggered"
        continue-on-error: true

      - name: Summary
        if: success()
        run: |
          echo "âœ… AIè¨˜äº‹ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸ"
          echo "ğŸ“… å®Ÿè¡Œæ—¥æ™‚: $(date)"
          echo "ğŸ“Š ç”Ÿæˆè¨˜äº‹æ•°: ${{ inputs.article_count || '3' }}"

      - name: Failure notification
        if: failure()
        run: |
          echo "âŒ AIè¨˜äº‹ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
          echo "ğŸ“‹ GitHub Actionsãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          echo "ğŸ”— https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
